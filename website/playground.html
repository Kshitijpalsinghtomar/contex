<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Playground â€” Contex</title>
    <meta name="description"
        content="Try Contex live â€” paste your JSON and watch each optimization stage reduce tokens in real-time.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
    <script>
        const theme = localStorage.getItem('contex-theme') || 'dark';
        document.documentElement.setAttribute('data-theme', theme);
    </script>
    <style>
        /* â”€â”€ Playground-specific styles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .playground-page {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: calc(var(--nav-height) + 40px) 24px 80px;
        }

        .playground-page h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .playground-page>p {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 1.05rem;
        }

        /* Split panes */
        .pg-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        @media (max-width: 900px) {
            .pg-grid {
                grid-template-columns: 1fr;
            }
        }

        .pg-pane {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .pg-pane-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-elevated);
        }

        .pg-pane-header h3 {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .pg-pane-header .badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: var(--radius-full);
            font-weight: 600;
        }

        .badge-red {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .badge-green {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .badge-blue {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
        }

        .badge-purple {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-purple);
        }

        .pg-textarea {
            width: 100%;
            min-height: 260px;
            padding: 16px;
            background: var(--bg-code);
            color: var(--text-primary);
            border: none;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.82rem;
            line-height: 1.6;
            resize: vertical;
            outline: none;
        }

        .pg-output {
            width: 100%;
            min-height: 260px;
            padding: 16px;
            background: var(--bg-code);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.82rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-y: auto;
            max-height: 400px;
        }

        /* Controls bar */
        .pg-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .pg-controls select {
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
        }

        /* Pipeline steps */
        .pipeline-section {
            margin-top: 40px;
        }

        .pipeline-section h2 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 24px;
        }

        .pipeline-steps {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .pipeline-step {
            position: relative;
            padding: 20px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            transition: all var(--transition);
            opacity: 0.4;
        }

        .pipeline-step.active {
            opacity: 1;
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px -8px var(--glow-brand);
        }

        .pipeline-step.done {
            opacity: 1;
        }

        .pipeline-connector {
            width: 2px;
            height: 20px;
            background: var(--border-subtle);
            margin-left: 36px;
        }

        .pipeline-connector.active {
            background: var(--accent-blue);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .pipeline-step.active .step-number {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .pipeline-step.done .step-number {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
        }

        .step-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .step-desc {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-left: 40px;
        }

        .step-preview {
            margin-top: 12px;
            margin-left: 40px;
            padding: 10px 14px;
            background: var(--bg-code);
            border-radius: var(--radius-sm);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 150px;
            overflow-y: auto;
            color: var(--text-primary);
        }

        .step-stats {
            display: flex;
            gap: 16px;
            margin-top: 8px;
            margin-left: 40px;
            font-size: 0.8rem;
        }

        .step-stat {
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Savings summary */
        .savings-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-top: 32px;
        }

        .savings-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
        }

        .savings-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .savings-card .label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Format comparison table */
        .format-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.85rem;
        }

        .format-table th,
        .format-table td {
            text-align: left;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .format-table th {
            font-weight: 600;
            color: var(--text-secondary);
            background: var(--bg-elevated);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .format-table td {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.82rem;
        }

        .format-table tr:hover td {
            background: var(--bg-hover);
        }

        .bar-cell {
            position: relative;
        }

        .bar-fill {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            opacity: 0.15;
            border-radius: 2px;
        }

        .bar-fill.green {
            background: var(--accent-green);
        }

        .bar-fill.red {
            background: var(--accent-red);
        }

        .bar-fill.blue {
            background: var(--accent-blue);
        }

        /* Play button animation */
        .btn-play {
            position: relative;
            overflow: hidden;
        }

        .btn-play::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
        }

        .btn-play.running::after {
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            to {
                transform: translateX(100%);
            }
        }

        /* External validation section */
        .ext-validation {
            margin-top: 48px;
            padding: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
        }

        .ext-validation h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .ext-validation p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 16px;
        }

        .ext-links {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .ext-link-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.85rem;
            transition: all var(--transition);
        }

        .ext-link-card:hover {
            border-color: var(--accent-blue);
            background: var(--bg-hover);
        }

        .highlight-green {
            color: var(--accent-green);
        }

        .highlight-red {
            color: var(--accent-red);
        }

        .highlight-blue {
            color: var(--accent-blue);
        }

        .highlight-amber {
            color: var(--accent-amber);
        }
    </style>
</head>

<body>
    <nav class="nav">
        <a href="/" class="nav-brand">
            <div class="logo-icon">C</div>
            Contex
        </a>
        <ul class="nav-links">
            <li><a href="./">Home</a></li>
            <li><a href="./docs.html">Docs</a></li>
            <li><a href="./tens-text.html">TENS-Text</a></li>
            <li><a href="./benchmarks.html">Benchmarks</a></li>
            <li><a href="./playground.html" class="active">Playground</a></li>
            <li><a href="./vision.html">Vision</a></li>
            <li><a href="./dashboard.html">Dashboard</a></li>
        </ul>
        <div class="nav-actions">
            <button class="btn btn-ghost btn-sm" id="theme-toggle" aria-label="Toggle theme">
                <svg class="sun-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg class="moon-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
            <a href="https://github.com/kshitijpalsinghtomar/contex" class="btn btn-ghost btn-sm" target="_blank">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                    <path
                        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
                    </path>
                </svg>
                GitHub
            </a>
        </div>
    </nav>

    <div class="playground-page">
        <h1>Interactive Playground</h1>
        <p>Paste your JSON data and watch each optimization stage reduce tokens in real-time. See exactly what Contex
            does, step by step.</p>

        <!-- Controls -->
        <div class="pg-controls">
            <button class="btn btn-primary btn-play" id="runBtn" onclick="runPipeline()">
                â–¶ Run Pipeline
            </button>
            <select id="sampleSelect" onchange="loadSample()">
                <option value="">Load sample data...</option>
                <option value="users">User Records (5 rows)</option>
                <option value="products">E-commerce Products (8 rows)</option>
                <option value="nested">Nested API Response (3 rows)</option>
                <option value="sparse">Sparse Sensor Data (6 rows)</option>
                <option value="large">Large Dataset (20 rows)</option>
            </select>
            <button class="btn btn-ghost btn-sm" onclick="clearAll()">Clear</button>
        </div>

        <!-- Input / Output split panes -->
        <div class="pg-grid">
            <div class="pg-pane">
                <div class="pg-pane-header">
                    <h3>Input â€” Raw JSON</h3>
                    <span class="badge badge-red" id="inputBadge">0 bytes</span>
                </div>
                <textarea class="pg-textarea" id="inputArea" spellcheck="false"
                    placeholder="Paste a JSON array of objects here...&#10;&#10;Example:&#10;[&#10;  { &quot;id&quot;: 1, &quot;name&quot;: &quot;Alice&quot;, &quot;role&quot;: &quot;Engineer&quot; },&#10;  { &quot;id&quot;: 2, &quot;name&quot;: &quot;Bob&quot;, &quot;role&quot;: &quot;Designer&quot; }&#10;]"></textarea>
            </div>
            <div class="pg-pane">
                <div class="pg-pane-header">
                    <h3>Output â€” Contex Compact</h3>
                    <span class="badge badge-green" id="outputBadge">0 bytes</span>
                </div>
                <div class="pg-output" id="outputArea">Run the pipeline to see optimized output...</div>
            </div>
        </div>

        <!-- Savings summary cards -->
        <div class="savings-summary" id="savingsSummary" style="display: none;">
            <div class="savings-card">
                <div class="value highlight-red" id="jsonBytes">â€”</div>
                <div class="label">JSON Bytes</div>
            </div>
            <div class="savings-card">
                <div class="value highlight-green" id="contexBytes">â€”</div>
                <div class="label">Contex Bytes</div>
            </div>
            <div class="savings-card">
                <div class="value highlight-blue" id="savingsPercent">â€”</div>
                <div class="label">Byte Savings</div>
            </div>
            <div class="savings-card">
                <div class="value highlight-amber" id="estimatedTokens">â€”</div>
                <div class="label">Est. Token Savings</div>
            </div>
        </div>

        <!-- Step-by-step pipeline walkthrough -->
        <div class="pipeline-section" id="pipelineSection" style="display: none;">
            <h2>Pipeline Walkthrough</h2>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">Watch each optimization stage transform your
                data. Click "Run Pipeline" above to animate.</p>

            <div class="pipeline-steps" id="pipelineSteps">
                <!-- Steps injected by JS -->
            </div>
        </div>

        <!-- Format comparison table -->
        <div class="pipeline-section" id="comparisonSection" style="display: none;">
            <h2>Format Comparison</h2>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">How your data looks in every output format.
            </p>
            <table class="format-table" id="formatTable">
                <thead>
                    <tr>
                        <th>Format</th>
                        <th>Bytes</th>
                        <th>vs JSON</th>
                        <th style="width: 40%;">Preview</th>
                    </tr>
                </thead>
                <tbody id="formatTableBody"></tbody>
            </table>
        </div>

        <!-- External Validation -->
        <div class="ext-validation">
            <h3>Validate Externally</h3>
            <p>Don't just take our word for it â€” verify the token counts yourself using these independent tools.
                Copy the Contex output above and paste it into any tokenizer to compare against the JSON input.</p>
            <div class="ext-links">
                <a href="https://platform.openai.com/tokenizer" target="_blank" rel="noopener" class="ext-link-card">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M12 6v6l4 2" />
                    </svg>
                    OpenAI Tokenizer â€” official GPT-4o tokenizer
                </a>
                <a href="https://tiktokenizer.vercel.app/" target="_blank" rel="noopener" class="ext-link-card">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" />
                        <path d="M3 9h18M3 15h18" />
                    </svg>
                    Tiktokenizer â€” visual token breakdown
                </a>
                <a href="https://tokencounter.onrender.com/" target="_blank" rel="noopener" class="ext-link-card">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z" />
                        <path d="M2 17l10 5 10-5" />
                        <path d="M2 12l10 5 10-5" />
                    </svg>
                    Token Counter â€” multi-model count
                </a>
            </div>
        </div>
    </div>

    <script>
        // â”€â”€ Contex Compact Encoder (browser-side, mirrors core/formatters.ts) â”€â”€

        // Helper: serialize any value for embedding inside a cell
        function serializeVal(v) {
            if (v === null || v === undefined) return '_';
            if (v === true) return 'T';
            if (v === false) return 'F';
            if (typeof v === 'string') return v;
            if (typeof v === 'number') return Number.isInteger(v) ? String(v) : String(v);
            if (Array.isArray(v)) {
                if (v.length > 0 && typeof v[0] === 'object' && v[0] !== null) {
                    // Nested array of objects: {k:v,k:v};{k:v,k:v}
                    return v.map(item => {
                        if (typeof item === 'object' && item !== null) {
                            return '{' + Object.entries(item)
                                .map(([ik, iv]) => `${ik}:${serializeVal(iv)}`)
                                .join(',') + '}';
                        }
                        return serializeVal(item);
                    }).join(';');
                }
                return v.map(serializeVal).join(' ');
            }
            if (typeof v === 'object') {
                return '{' + Object.entries(v)
                    .map(([ik, iv]) => `${ik}:${serializeVal(iv)}`)
                    .join(',') + '}';
            }
            return String(v);
        }

        function deepFlatten(obj, prefix = '') {
            const result = {};
            for (const [key, val] of Object.entries(obj)) {
                const fullKey = prefix ? `${prefix}.${key}` : key;
                if (val !== null && typeof val === 'object' && !Array.isArray(val)) {
                    Object.assign(result, deepFlatten(val, fullKey));
                } else if (Array.isArray(val) && val.length > 0 && typeof val[0] === 'object' && val[0] !== null) {
                    const subKeys = Object.keys(val[0]);
                    result[fullKey] = val.map(item => {
                        if (typeof item === 'object' && item !== null) {
                            return subKeys.map(sk => {
                                const v = item[sk];
                                return serializeVal(v);
                            }).join(' ');
                        }
                        return serializeVal(item);
                    }).join('|');
                    if (!result[`${fullKey}@`]) {
                        result[`${fullKey}@`] = subKeys.join(' ');
                    }
                } else {
                    result[fullKey] = val;
                }
            }
            return result;
        }

        function compressFieldNames(keys) {
            const compressed = new Map();
            // Find shortest unique prefix for each key
            for (const key of keys) {
                let prefix = '';
                for (let len = 1; len <= key.length; len++) {
                    prefix = key.substring(0, len);
                    const conflicts = keys.filter(k => k !== key && k.startsWith(prefix));
                    if (conflicts.length === 0) break;
                }
                compressed.set(key, prefix.length < key.length ? prefix : key);
            }
            return compressed;
        }

        function formatVal(val, dictMap) {
            if (val === null || val === undefined) return '_';
            if (val === true) return 'T';
            if (val === false) return 'F';
            if (typeof val === 'string') {
                if (val.length === 0) return '_';
                const dictIdx = dictMap.get(val);
                if (dictIdx !== undefined) return `@${dictIdx}`;
                if (val.includes('\t') || val.includes('\n')) {
                    return val.replace(/\t/g, '\\t').replace(/\n/g, '\\n');
                }
                // Safety: escape strings that look like dictionary references
                if (/^@\d+$/.test(val)) return `\\${val}`;
                return val;
            }
            if (typeof val === 'number') {
                const numStr = Number.isInteger(val) ? String(val) : String(val);
                const dictIdx = dictMap.get(numStr);
                if (dictIdx !== undefined) return `@${dictIdx}`;
                return numStr;
            }
            if (Array.isArray(val)) return val.map(v => formatVal(v, dictMap)).join(' ');
            if (typeof val === 'object') return JSON.stringify(val);
            return String(val);
        }

        function encodeContexCompact(data) {
            if (!Array.isArray(data) || data.length === 0) return '';

            const stages = []; // Collect intermediate results for visualization

            // Stage 0: Raw JSON
            stages.push({
                name: 'Raw JSON',
                desc: 'Original structured data as JSON â€” verbose with brackets, quotes, colons, commas.',
                output: JSON.stringify(data, null, 2),
                icon: 'ðŸ“¥'
            });

            // Stage 1: Deep Flatten
            const flatRows = data.map(r => deepFlatten(r));
            const flatPreview = JSON.stringify(flatRows, null, 2);
            stages.push({
                name: 'Deep Flatten',
                desc: 'Nested objects become dot-notation keys (e.g. address.city). Single flat row per record.',
                output: flatPreview,
                icon: 'ðŸ—‚ï¸'
            });

            // Collect all keys
            const allKeys = new Set();
            for (const row of flatRows) {
                for (const key of Object.keys(row)) {
                    if (!key.endsWith('@')) allKeys.add(key);
                }
            }
            const keys = Array.from(allKeys);

            // Stage 2: Tab-separated (no compression yet)
            const rawHeader = keys.join('\t');
            const rawRows = flatRows.map(row => keys.map(k => {
                const val = row[k];
                if (val === null || val === undefined) return '';
                if (typeof val === 'boolean') return String(val);
                return String(val);
            }).join('\t'));
            stages.push({
                name: 'Tab-Separated Schema',
                desc: 'Schema declared once as header. No repeated key names. Tab-delimited, no brackets or quotes.',
                output: [rawHeader, ...rawRows].join('\n'),
                icon: 'ðŸ“'
            });

            // Stage 3: Boolean/null abbreviation
            const abbrevRows = flatRows.map(row => keys.map(k => {
                const val = row[k];
                if (val === null || val === undefined || val === '') return '_';
                if (val === true) return 'T';
                if (val === false) return 'F';
                if (typeof val === 'number') return Number.isInteger(val) ? String(val) : String(val);
                return String(val);
            }).join('\t'));
            stages.push({
                name: 'Boolean & Null Abbreviation',
                desc: 'trueâ†’T, falseâ†’F, null/emptyâ†’_. Integer shortening: 42.0â†’42.',
                output: [rawHeader, ...abbrevRows].join('\n'),
                icon: 'âœ‚ï¸'
            });

            // Stage 4: Field name compression
            const fieldCompression = compressFieldNames(keys);
            const shortKeys = keys.map(k => fieldCompression.get(k) || k);
            const anyCompressed = keys.some((k, i) => shortKeys[i] !== k && shortKeys[i].length < k.length);

            let fieldOutput = shortKeys.join('\t');
            if (anyCompressed) {
                const mapping = keys.map((k, i) => shortKeys[i] !== k ? `${shortKeys[i]}=${k}` : '').filter(Boolean);
                if (mapping.length > 0) fieldOutput += '\n@f\t' + mapping.join('\t');
            }
            fieldOutput += '\n' + abbrevRows.join('\n');
            stages.push({
                name: 'Field Name Compression',
                desc: 'Shortest unique prefix for each column. Mapping line (@f) preserves original names.',
                output: fieldOutput,
                icon: 'ðŸ·ï¸'
            });

            // Stage 5: Dictionary compression
            const valueCounts = new Map();
            for (const row of flatRows) {
                for (const k of keys) {
                    const val = row[k];
                    if (typeof val === 'string' && val.length > 1) {
                        valueCounts.set(val, (valueCounts.get(val) || 0) + 1);
                    }
                    if (typeof val === 'number') {
                        const numStr = Number.isInteger(val) ? String(val) : String(val);
                        if (numStr.length > 2) {
                            valueCounts.set(numStr, (valueCounts.get(numStr) || 0) + 1);
                        }
                    }
                }
            }

            const dictionary = [];
            const dictMap = new Map();
            const candidates = [...valueCounts.entries()]
                .filter(([val, count]) => {
                    // Force-include strings that look like dict refs to avoid ambiguity
                    if (/^@\d+$/.test(val)) return true;
                    return count >= 2 && val.length > 1;
                })
                .sort((a, b) => (b[1] * b[0].length) - (a[1] * a[0].length));
            for (const [val] of candidates) {
                dictMap.set(val, dictionary.length);
                dictionary.push(val);
            }

            // Sparsity detection
            let nullCells = 0;
            const totalCells = flatRows.length * keys.length;
            for (const row of flatRows) {
                for (const k of keys) {
                    const val = row[k];
                    if (val === null || val === undefined || val === '') nullCells++;
                }
            }
            const sparsityRatio = totalCells > 0 ? nullCells / totalCells : 0;

            // Final output
            const lines = [];
            if (sparsityRatio > 0.5) {
                lines.push('@sparse');
                lines.push(shortKeys.join('\t'));
                if (anyCompressed) {
                    const mapping = keys.map((k, i) => shortKeys[i] !== k ? `${shortKeys[i]}=${k}` : '').filter(Boolean);
                    if (mapping.length > 0) lines.push('@f\t' + mapping.join('\t'));
                }
                if (dictionary.length > 0) {
                    lines.push('@d\t' + dictionary.join('\t'));
                }
                for (const row of flatRows) {
                    const parts = [];
                    for (let i = 0; i < keys.length; i++) {
                        const val = row[keys[i]];
                        if (val !== null && val !== undefined && val !== '') {
                            parts.push(`${i}:${formatVal(val, dictMap)}`);
                        }
                    }
                    lines.push(parts.join('\t'));
                }
            } else {
                lines.push(shortKeys.join('\t'));
                if (anyCompressed) {
                    const mapping = keys.map((k, i) => shortKeys[i] !== k ? `${shortKeys[i]}=${k}` : '').filter(Boolean);
                    if (mapping.length > 0) lines.push('@f\t' + mapping.join('\t'));
                }
                if (dictionary.length > 0) {
                    lines.push('@d\t' + dictionary.join('\t'));
                }
                for (const row of flatRows) {
                    const vals = keys.map(k => formatVal(row[k], dictMap));
                    lines.push(vals.join('\t'));
                }
            }

            const finalOutput = lines.join('\n');
            const dictInfo = dictionary.length > 0
                ? `Dictionary: ${dictionary.length} entries. Repeated values replaced with @0, @1, etc.`
                : 'No repeated values found â€” dictionary not needed.';
            const sparseInfo = sparsityRatio > 0.5
                ? `Sparse mode activated (${(sparsityRatio * 100).toFixed(0)}% null). Only non-null cells emitted.`
                : '';

            stages.push({
                name: 'Dictionary Compression' + (sparsityRatio > 0.5 ? ' + Sparse Mode' : ''),
                desc: `${dictInfo} ${sparseInfo}`.trim(),
                output: finalOutput,
                icon: 'ðŸ“–'
            });

            return { stages, finalOutput };
        }

        // â”€â”€ Other format encoders (simplified browser versions) â”€â”€

        function formatCSV(data) {
            if (data.length === 0) return '';
            const keys = Object.keys(data[0]);
            const header = keys.join(',');
            const rows = data.map(row => keys.map(k => {
                const val = row[k];
                if (val === null || val === undefined) return '';
                if (typeof val === 'string' && (val.includes(',') || val.includes('"') || val.includes('\n'))) {
                    return `"${val.replace(/"/g, '""')}"`;
                }
                if (typeof val === 'object') return JSON.stringify(val);
                return String(val);
            }).join(','));
            return [header, ...rows].join('\n');
        }

        function formatMarkdown(data) {
            if (data.length === 0) return '';
            const keys = Object.keys(data[0]);
            const header = `| ${keys.join(' | ')} |`;
            const separator = `| ${keys.map(() => '---').join(' | ')} |`;
            const rows = data.map(row => `| ${keys.map(k => {
                const val = row[k];
                if (val === null || val === undefined) return '';
                if (typeof val === 'object') return JSON.stringify(val);
                return String(val);
            }).join(' | ')} |`);
            return [header, separator, ...rows].join('\n');
        }

        function formatTOON(data) {
            if (data.length === 0) return '';
            const keys = Object.keys(data[0]);
            const header = keys.join('\t');
            const rows = data.map(row => keys.map(k => {
                const val = row[k];
                if (val === null || val === undefined) return '';
                if (typeof val === 'object') return JSON.stringify(val);
                return String(val);
            }).join('\t'));
            return [header, ...rows].join('\n');
        }

        // â”€â”€ Sample datasets â”€â”€

        const SAMPLES = {
            users: [
                { id: 1, name: "Alice Johnson", email: "alice@company.com", role: "Engineer", department: "Backend", active: true, salary: 125000 },
                { id: 2, name: "Bob Smith", email: "bob@company.com", role: "Designer", department: "Frontend", active: true, salary: 115000 },
                { id: 3, name: "Carol White", email: "carol@company.com", role: "Engineer", department: "Backend", active: false, salary: 130000 },
                { id: 4, name: "Dave Brown", email: "dave@company.com", role: "Manager", department: "Backend", active: true, salary: 145000 },
                { id: 5, name: "Eve Davis", email: "eve@company.com", role: "Engineer", department: "Frontend", active: true, salary: 120000 }
            ],
            products: [
                { sku: "LAPTOP-001", name: "ProBook 15", category: "Electronics", price: 1299.99, stock: 45, rating: 4.5, warehouse: "US-West", onSale: false },
                { sku: "LAPTOP-002", name: "UltraSlim 13", category: "Electronics", price: 999.99, stock: 120, rating: 4.8, warehouse: "US-West", onSale: true },
                { sku: "PHONE-001", name: "Galaxy Pro", category: "Electronics", price: 899.99, stock: 200, rating: 4.3, warehouse: "US-East", onSale: false },
                { sku: "DESK-001", name: "Standing Desk XL", category: "Furniture", price: 549.99, stock: 30, rating: 4.6, warehouse: "US-East", onSale: true },
                { sku: "CHAIR-001", name: "Ergo Chair Pro", category: "Furniture", price: 449.99, stock: 75, rating: 4.7, warehouse: "US-West", onSale: false },
                { sku: "MONITOR-001", name: "UltraWide 34", category: "Electronics", price: 699.99, stock: 60, rating: 4.4, warehouse: "US-West", onSale: true },
                { sku: "KB-001", name: "MechKey 75", category: "Accessories", price: 149.99, stock: 300, rating: 4.9, warehouse: "US-East", onSale: false },
                { sku: "MOUSE-001", name: "ProClick Wireless", category: "Accessories", price: 79.99, stock: 500, rating: 4.2, warehouse: "US-East", onSale: true }
            ],
            nested: [
                { id: 1, user: { name: "Alice", age: 30 }, address: { city: "Seattle", state: "WA", zip: "98101" }, preferences: { theme: "dark", notifications: true, language: "en" } },
                { id: 2, user: { name: "Bob", age: 25 }, address: { city: "Portland", state: "OR", zip: "97201" }, preferences: { theme: "light", notifications: false, language: "en" } },
                { id: 3, user: { name: "Carol", age: 35 }, address: { city: "Seattle", state: "WA", zip: "98102" }, preferences: { theme: "dark", notifications: true, language: "fr" } }
            ],
            sparse: [
                { sensor_id: "T-001", temperature: 72.5, humidity: null, pressure: null, co2: null, light: 850, motion: true },
                { sensor_id: "T-002", temperature: null, humidity: 45.2, pressure: null, co2: null, light: null, motion: false },
                { sensor_id: "T-003", temperature: null, humidity: null, pressure: 1013.25, co2: 420, light: null, motion: null },
                { sensor_id: "T-004", temperature: 68.1, humidity: null, pressure: null, co2: null, light: 920, motion: true },
                { sensor_id: "T-005", temperature: null, humidity: 52.8, pressure: null, co2: null, light: null, motion: null },
                { sensor_id: "T-006", temperature: null, humidity: null, pressure: 1015.5, co2: 385, light: null, motion: false }
            ],
            large: (() => {
                const departments = ['Engineering', 'Sales', 'Marketing', 'Support', 'Product', 'Design'];
                const cities = ['San Francisco', 'New York', 'Seattle', 'Austin', 'Chicago', 'Denver'];
                const firstNames = ['James', 'Mary', 'John', 'Patricia', 'Robert', 'Jennifer', 'Michael', 'Linda', 'William', 'Elizabeth', 'David', 'Barbara', 'Richard', 'Susan', 'Joseph', 'Jessica', 'Thomas', 'Sarah', 'Charles', 'Karen'];
                const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson', 'Thomas', 'Taylor', 'Moore', 'Jackson', 'Martin'];
                return Array.from({ length: 20 }, (_, i) => ({
                    id: i + 1,
                    name: `${firstNames[i]} ${lastNames[i]}`,
                    email: `${firstNames[i].toLowerCase()}.${lastNames[i].toLowerCase()}@company.com`,
                    department: departments[i % departments.length],
                    city: cities[i % cities.length],
                    salary: 80000 + Math.floor(i * 5000),
                    active: i % 3 !== 0,
                    start_year: 2018 + (i % 7),
                    performance_score: +(3.0 + (i % 20) * 0.1).toFixed(1)
                }));
            })()
        };

        // â”€â”€ UI Logic â”€â”€

        function updateInputBadge() {
            const text = document.getElementById('inputArea').value;
            const bytes = new TextEncoder().encode(text).length;
            document.getElementById('inputBadge').textContent = `${bytes.toLocaleString()} bytes`;
        }

        document.getElementById('inputArea').addEventListener('input', updateInputBadge);

        function loadSample() {
            const select = document.getElementById('sampleSelect');
            const key = select.value;
            if (!key || !SAMPLES[key]) return;
            document.getElementById('inputArea').value = JSON.stringify(SAMPLES[key], null, 2);
            updateInputBadge();
        }

        function clearAll() {
            document.getElementById('inputArea').value = '';
            document.getElementById('outputArea').textContent = 'Run the pipeline to see optimized output...';
            document.getElementById('inputBadge').textContent = '0 bytes';
            document.getElementById('outputBadge').textContent = '0 bytes';
            document.getElementById('savingsSummary').style.display = 'none';
            document.getElementById('pipelineSection').style.display = 'none';
            document.getElementById('comparisonSection').style.display = 'none';
            document.getElementById('sampleSelect').value = '';
        }

        async function runPipeline() {
            const inputText = document.getElementById('inputArea').value.trim();
            if (!inputText) {
                alert('Please paste some JSON data or load a sample dataset.');
                return;
            }

            let data;
            try {
                data = JSON.parse(inputText);
                if (!Array.isArray(data)) {
                    if (typeof data === 'object') data = [data];
                    else throw new Error('Expected array or object');
                }
            } catch (e) {
                alert('Invalid JSON: ' + e.message);
                return;
            }

            const btn = document.getElementById('runBtn');
            btn.classList.add('running');
            btn.disabled = true;

            // Run the encoder
            const { stages, finalOutput } = encodeContexCompact(data);

            // Show output
            document.getElementById('outputArea').textContent = finalOutput;
            const jsonBytes = new TextEncoder().encode(JSON.stringify(data)).length;
            const contexBytes = new TextEncoder().encode(finalOutput).length;
            const savingsPercent = ((1 - contexBytes / jsonBytes) * 100).toFixed(1);
            // Estimate tokens (rough heuristic: ~4 bytes per token for English text)
            const jsonTokensEst = Math.ceil(jsonBytes / 3.5);
            const contexTokensEst = Math.ceil(contexBytes / 3.5);
            const tokenSavingsPercent = ((1 - contexTokensEst / jsonTokensEst) * 100).toFixed(1);

            document.getElementById('outputBadge').textContent = `${contexBytes.toLocaleString()} bytes (${savingsPercent}% smaller)`;

            // Savings summary
            document.getElementById('jsonBytes').textContent = jsonBytes.toLocaleString();
            document.getElementById('contexBytes').textContent = contexBytes.toLocaleString();
            document.getElementById('savingsPercent').textContent = savingsPercent + '%';
            document.getElementById('estimatedTokens').textContent = `~${tokenSavingsPercent}%`;
            document.getElementById('savingsSummary').style.display = '';

            // Pipeline steps
            const stepsContainer = document.getElementById('pipelineSteps');
            stepsContainer.innerHTML = '';

            for (let i = 0; i < stages.length; i++) {
                const stage = stages[i];
                const stageBytes = new TextEncoder().encode(stage.output).length;
                const reduction = i > 0 ? ((1 - stageBytes / jsonBytes) * 100).toFixed(1) : '0';

                if (i > 0) {
                    const connector = document.createElement('div');
                    connector.className = 'pipeline-connector';
                    connector.id = `connector-${i}`;
                    stepsContainer.appendChild(connector);
                }

                const step = document.createElement('div');
                step.className = 'pipeline-step';
                step.id = `step-${i}`;
                step.innerHTML = `
                    <div class="step-header">
                        <div class="step-number">${i + 1}</div>
                        <div class="step-title">${stage.icon} ${stage.name}</div>
                    </div>
                    <div class="step-desc">${stage.desc}</div>
                    <div class="step-stats">
                        <span class="step-stat badge-blue">${stageBytes.toLocaleString()} bytes</span>
                        ${i > 0 ? `<span class="step-stat badge-green">-${reduction}% from JSON</span>` : '<span class="step-stat badge-red">Baseline</span>'}
                    </div>
                    <div class="step-preview">${escapeHtml(stage.output.substring(0, 600))}${stage.output.length > 600 ? '\n...' : ''}</div>
                `;
                stepsContainer.appendChild(step);
            }

            document.getElementById('pipelineSection').style.display = '';

            // Animate steps
            for (let i = 0; i < stages.length; i++) {
                await sleep(400);
                if (i > 0) document.getElementById(`connector-${i}`).classList.add('active');
                document.getElementById(`step-${i}`).classList.add('active');
                if (i > 0) document.getElementById(`step-${i - 1}`).classList.remove('active');
                document.getElementById(`step-${i > 0 ? i - 1 : i}`).classList.add('done');
            }
            // Mark last step done
            document.getElementById(`step-${stages.length - 1}`).classList.add('done');

            // Format comparison table
            buildFormatTable(data, jsonBytes);

            btn.classList.remove('running');
            btn.disabled = false;
        }

        function buildFormatTable(data, jsonBytes) {
            const formats = [
                { name: 'JSON (pretty)', fn: d => JSON.stringify(d, null, 2) },
                { name: 'JSON (minified)', fn: d => JSON.stringify(d) },
                { name: 'CSV', fn: formatCSV },
                { name: 'Markdown', fn: formatMarkdown },
                { name: 'TOON (tabs)', fn: formatTOON },
                { name: 'Contex Compact', fn: d => encodeContexCompact(d).finalOutput }
            ];

            const tbody = document.getElementById('formatTableBody');
            tbody.innerHTML = '';

            const results = formats.map(f => {
                const output = f.fn(data);
                const bytes = new TextEncoder().encode(output).length;
                return { name: f.name, bytes, output };
            });

            // Sort by bytes ascending
            results.sort((a, b) => a.bytes - b.bytes);
            const minBytes = results[0].bytes;

            for (const r of results) {
                const pct = ((1 - r.bytes / jsonBytes) * 100).toFixed(1);
                const isSmallest = r.bytes === minBytes;
                const barWidth = (r.bytes / jsonBytes * 100).toFixed(0);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="${isSmallest ? 'font-weight: 700; color: var(--accent-green);' : ''}">${r.name}${isSmallest ? ' â˜…' : ''}</td>
                    <td>${r.bytes.toLocaleString()}</td>
                    <td class="bar-cell">
                        <div class="bar-fill ${Number(pct) > 0 ? 'green' : 'red'}" style="width: ${Math.min(100, Math.abs(barWidth))}%"></div>
                        <span style="position: relative; color: ${Number(pct) > 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                            ${Number(pct) > 0 ? '-' : '+'}${Math.abs(pct)}%
                        </span>
                    </td>
                    <td style="font-size: 0.75rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(r.output.substring(0, 120))}</td>
                `;
                tbody.appendChild(tr);
            }

            document.getElementById('comparisonSection').style.display = '';
        }

        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // â”€â”€ Theme toggle (same as other pages) â”€â”€
        document.getElementById('theme-toggle').addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme') || 'dark';
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('contex-theme', next);
            const sunIcon = document.querySelector('.sun-icon');
            const moonIcon = document.querySelector('.moon-icon');
            if (sunIcon && moonIcon) {
                sunIcon.style.display = next === 'light' ? 'block' : 'none';
                moonIcon.style.display = next === 'dark' ? 'block' : 'none';
            }
        });
        // Init theme icon
        (() => {
            const t = document.documentElement.getAttribute('data-theme') || 'dark';
            const sunIcon = document.querySelector('.sun-icon');
            const moonIcon = document.querySelector('.moon-icon');
            if (sunIcon && moonIcon) {
                sunIcon.style.display = t === 'light' ? 'block' : 'none';
                moonIcon.style.display = t === 'dark' ? 'block' : 'none';
            }
        })();
    </script>
</body>

</html>
